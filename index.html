<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Functional Prototype - Jettacars</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        .font-mono { font-family: 'Roboto Mono', monospace; }
        .glass-card { background: rgba(31, 41, 55, 0.5); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .brand-gradient { background: linear-gradient(to right, #f97316, #ea580c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        canvas { display: block; width: 100%; height: 100%; border-radius: 0.375rem; cursor: move; }
        #bot-code-editor {
            background-color: #0d1117;
            color: #c9d1d9;
            border: 1px solid #30363d;
            font-family: 'Roboto Mono', monospace;
            font-size: 14px;
            line-height: 1.5;
        }
        .code-block { background-color: #0d1117; color: #c9d1d9; padding: 1rem; border-radius: 0.5rem; font-family: 'Roboto Mono', monospace; white-space: pre-wrap; border: 1px solid #30363d;}
        @keyframes pulse { 50% { opacity: .5; } }
        .animate-pulse-fast { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="text-gray-200">

    <header class="glass-card shadow-lg sticky top-0 z-20">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold tracking-tighter">
                Jetta<span class="brand-gradient">Cars</span>
            </h1>
            <div class="flex items-center space-x-2">
                <label for="bot-name-input" class="text-gray-400">Bot:</label>
                <input type="text" id="bot-name-input" class="bg-gray-800 border border-gray-600 rounded px-2 py-1 text-white font-bold w-48" value="DummyBot_v1">
            </div>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8">
        
        <!-- Editor Section -->
        <section id="bot-editor-section" class="mb-16">
            <h2 class="text-4xl font-bold text-center mb-8">Bot Editor</h2>
            <div class="glass-card rounded-xl p-4">
                <textarea id="bot-code-editor" class="w-full h-96 rounded-md p-4" spellcheck="false"></textarea>
                <div class="mt-4 flex justify-between items-center">
                    <p id="code-status" class="text-sm text-gray-400">Ready to start. Example code is already loaded.</p>
                    <div class="flex space-x-4">
                        <a href="#rules-doc-section" class="bg-gray-600 hover:bg-gray-700 text-white font-bold rounded-lg text-lg px-8 py-3 transition-colors duration-300">
                            View Rules & API
                        </a>
                        <button id="run-bot-button" class="bg-orange-600 hover:bg-orange-700 text-white font-bold rounded-lg text-lg px-8 py-3 transition-transform duration-300 hover:scale-105">
                            Start / Restart Simulation
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <hr class="border-gray-700 my-16">

        <section id="execution-section">
            <h2 class="text-4xl font-bold text-center mb-12">Execution Visualizer</h2>
            
            <!-- Metrics Panel -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 text-center mb-8">
                <div class="glass-card rounded-lg p-4"><p class="text-sm text-gray-400">CURRENT TICK</p><p id="metric-tick" class="text-3xl font-bold font-mono">0</p></div>
                <div class="glass-card rounded-lg p-4"><p class="text-sm text-gray-400">CURRENT PROFIT</p><p id="metric-lucro" class="text-3xl font-bold font-mono text-green-400">$ 0</p></div>
                <div class="glass-card rounded-lg p-4"><p class="text-sm text-gray-400">PEAK PROFIT</p><p id="metric-pico-lucro" class="text-3xl font-bold font-mono text-orange-400">$ 0</p></div>
                <div class="glass-card rounded-lg p-4"><p class="text-sm text-gray-400">BOT STATUS</p><div id="metric-status" class="flex items-center justify-center space-x-2 mt-2"><span class="relative flex h-3 w-3"><span class="animate-pulse-fast absolute inline-flex h-full w-full rounded-full bg-gray-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-gray-500"></span></span><p id="status-text" class="text-xl font-bold text-gray-400">STOPPED</p></div></div>
            </div>

            <!-- Docks Visualization -->
            <div>
                <h3 class="text-2xl font-bold mb-4">Loading Docks</h3>
                <div id="docks-container" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-4 gap-6">
                    <!-- Docks will be dynamically generated by JavaScript -->
                </div>
            </div>

            <!-- Log Panel -->
            <div class="mt-8">
                <h3 class="text-2xl font-bold mb-4">Event Log</h3>
                <div class="glass-card rounded-xl p-4 h-64 overflow-y-auto">
                    <div id="log-content" class="font-mono text-sm space-y-2"></div>
                </div>
            </div>
        </section>
        
        <hr class="border-gray-700 my-16">

        <!-- Rules and API Documentation Section -->
        <section id="rules-doc-section" class="py-16">
             <div class="max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-4xl font-bold">Rules & <span class="brand-gradient">API</span></h2>
                    <a href="#bot-editor-section" class="bg-gray-600 hover:bg-gray-700 text-white font-bold rounded-lg text-lg px-8 py-3 transition-colors duration-300">
                        Back to Editor
                    </a>
                </div>

                <div class="space-y-8">
                    <div class="glass-card rounded-xl p-8">
                        <h3 class="text-2xl font-bold mb-4 text-orange-400">Game Rules</h3>
                        <div class="space-y-4">
                            <div>
                                <h4 class="text-xl font-semibold mb-2">The Objective</h4>
                                <p>Your goal is simple: <strong>maximize profit</strong>. You manage loading parts into trucks to fulfill orders. The final score is the <strong>highest peak profit</strong> you achieved. The game ends if any dismissal criteria are met.</p>
                            </div>
                            <div>
                                <h4 class="text-xl font-semibold mb-2 text-red-400">Dismissal Criteria (End of Game)</h4>
                                <ul class="list-disc list-inside space-y-2 text-gray-300">
                                    <li><strong>Order Expired:</strong> Failing to dispatch an order before its 50-tick deadline.</li>
                                    <li><strong>Incomplete Order:</strong> Attempting to dispatch a truck (`dispatch`) that does not contain all items for one or more complete orders.</li>
                                    <li><strong>Empty Truck:</strong> Attempting to dispatch a truck with no items inside.</li>
                                    <li><strong>Out of Bounds:</strong> Placing a part, even partially, outside the truck's cargo area.</li>
                                    <li><strong>Item Collision:</strong> Placing a part that overlaps with another in 3D space.</li>
                                    <li><strong>Lack of Support:</strong> Placing a part "floating" without a complete support base beneath it.</li>
                                    <li><strong>Overweight:</strong> The total weight of parts exceeding the truck's limit.</li>
                                    <li><strong>Inactivity:</strong> Not sending any valid actions for 6 consecutive ticks.</li>
                                    <li><strong>Continuous Loss:</strong> Maintaining a negative balance for 100 consecutive ticks.</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                     <div class="glass-card rounded-xl p-8">
                        <h3 class="text-2xl font-bold mb-4 text-orange-400">Game Economy</h3>
                        <div class="space-y-4 text-gray-300">
                            <p>Financial management is crucial. Your costs are immediate, but profit only comes upon delivery.</p>
                            <ul class="list-disc list-inside space-y-2">
                                <li><strong>Cost per Tick:</strong> Each tick, an operational cost is deducted from your profit. This cost starts at <strong>$1</strong> and increases by <strong>$0.5</strong> each tick, making time efficiency vital.</li>
                                <li><strong>Transportation Cost:</strong> The cost of a truck is paid **at the moment of request** (`request_truck`). This is an investment you need to recover.</li>
                                <li><strong>Profit on Delivery:</strong> When you dispatch a truck with a complete order (`dispatch`), you receive the full `lucroMaximo` (maximum profit) for that order. The challenge is to ensure the profit from orders on a truck exceeds the initial transport cost and accumulated operational costs.</li>
                            </ul>
                        </div>
                    </div>

                    <div class="glass-card rounded-xl p-8">
                        <h3 class="text-2xl font-bold mb-4 text-orange-400">Bot Interaction (API)</h3>
                         <p class="mb-4 text-gray-300">On each tick, your script is executed. You must use the global functions `readline()`, `print()`, and `debug()` to interact with the game.</p>
                        <div class="space-y-6">
                            <div>
                                <h4 class="text-xl font-semibold mb-1 font-mono">readline()</h4>
                                <p class="text-gray-400 mb-2">Reads the current game state. Returns a **JSON string** that you must parse.</p>
                                <div class="code-block">const gameState = JSON.parse(readline());</div>
                            </div>
                            <div>
                                <h4 class="text-xl font-semibold mb-1 font-mono">print(command)</h4>
                                <p class="text-gray-400 mb-2">Sends an action command to the game engine. You can call `print()` multiple times per tick.</p>
                                <div class="code-block">print('request_truck small dock_1');</div>
                            </div>
                             <div>
                                <h4 class="text-xl font-semibold mb-1 font-mono">debug(message)</h4>
                                <p class="text-gray-400 mb-2">Sends a debug message to the event log. It does not count as an action and does not affect the game.</p>
                                <div class="code-block">debug('Checking for available docks...');</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="glass-card rounded-xl p-8">
                        <h3 class="text-2xl font-bold mb-4 text-orange-400">Parts and Orders</h3>
                        <p class="mb-4 text-gray-300">Orders are composed of one or more units of each Jeggy model. Below are all the parts that make up each model.</p>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="border-b border-gray-600 text-gray-400">
                                    <tr>
                                        <th class="p-2">Part Type</th>
                                        <th class="p-2">Dimensions (L x W x H)</th>
                                        <th class="p-2">Weight (kg)</th>
                                    </tr>
                                </thead>
                                <tbody class="font-mono text-sm">
                                    <tr class="border-b border-gray-700"><td class="p-2 font-bold text-orange-400" colspan="3">Small (3 Wheels)</td></tr>
                                    <tr class="border-b border-gray-700"><td class="p-2 pl-6">common_wheel (x3)</td><td class="p-2">0.6 x 0.6 x 0.2</td><td class="p-2">15</td></tr>
                                    <tr class="border-b border-gray-700"><td class="p-2 pl-6">chassis_3_wheels</td><td class="p-2">2.2 x 1.4 x 0.4</td><td class="p-2">180</td></tr>
                                    <tr class="border-b border-gray-700"><td class="p-2 pl-6">suspension_small_f</td><td class="p-2">0.3 x 0.8 x 0.3</td><td class="p-2">22</td></tr>
                                    <tr class="border-b border-gray-700"><td class="p-2 pl-6">suspension_small_r</td><td class="p-2">1.2 x 0.3 x 0.3</td><td class="p-2">28</td></tr>
                                    <tr class="border-b border-gray-700"><td class="p-2 pl-6">engine_small</td><td class="p-2">0.6 x 0.5 x 0.5</td><td class="p-2">60</td></tr>
                                    <tr class="border-b border-gray-700"><td class="p-2 pl-6">transmission_small</td><td class="p-2">0.4 x 0.4 x 0.4</td><td class="p-2">45</td></tr>
                                    <tr class="border-b border-gray-700"><td class="p-2 pl-6">body_small</td><td class="p-2">2.4 x 1.5 x 1.5</td><td class="p-2">120</td></tr>
                                    
                                    <tr class="border-b border-gray-700"><td class="p-2 font-bold text-orange-400" colspan="3">Mid (4 Wheels)</td></tr>
                                    <tr class="border-b border-gray-700"><td class="p-2 pl-6">common_wheel (x4)</td><td class="p-2">0.6 x 0.6 x 0.2</td><td class="p-2">15</td></tr>
                                    <tr class="border-b border-gray-700"><td class="p-2 pl-6">chassis_4_wheels</td><td class="p-2">2.8 x 1.6 x 0.4</td><td class="p-2">250</td></tr>
                                    <tr class="border-b border-gray-700"><td class="p-2 pl-6">suspension_mid_f</td><td class="p-2">0.4 x 1.0 x 0.4</td><td class="p-2">35</td></tr>
                                    <tr class="border-b border-gray-700"><td class="p-2 pl-6">suspension_mid_r</td><td class="p-2">0.4 x 1.0 x 0.4</td><td class="p-2">35</td></tr>
                                    <tr class="border-b border-gray-700"><td class="p-2 pl-6">engine_mid</td><td class="p-2">0.7 x 0.6 x 0.5</td><td class="p-2">95</td></tr>
                                    <tr class="border-b border-gray-700"><td class="p-2 pl-6">transmission_mid</td><td class="p-2">0.5 x 0.5 x 0.5</td><td class="p-2">70</td></tr>
                                    <tr class="border-b border-gray-700"><td class="p-2 pl-6">body_mid</td><td class="p-2">3.0 x 1.7 x 1.5</td><td class="p-2">180</td></tr>

                                    <tr class="border-b border-gray-700"><td class="p-2 font-bold text-orange-400" colspan="3">Big (4 Wheels)</td></tr>
                                    <tr class="border-b border-gray-700"><td class="p-2 pl-6">offroad_wheel (x4)</td><td class="p-2">0.8 x 0.8 x 0.3</td><td class="p-2">35</td></tr>
                                    <tr class="border-b border-gray-700"><td class="p-2 pl-6">reinforced_chassis</td><td class="p-2">3.2 x 1.8 x 0.5</td><td class="p-2">400</td></tr>
                                    <tr class="border-b border-gray-700"><td class="p-2 pl-6">suspension_big_f</td><td class="p-2">0.5 x 1.2 x 0.5</td><td class="p-2">55</td></tr>
                                    <tr class="border-b border-gray-700"><td class="p-2 pl-6">suspension_big_r</td><td class="p-2">0.5 x 1.2 x 0.5</td><td class="p-2">55</td></tr>
                                    <tr class="border-b border-gray-700"><td class="p-2 pl-6">engine_big</td><td class="p-2">0.8 x 0.6 x 0.6</td><td class="p-2">140</td></tr>
                                    <tr class="border-b border-gray-700"><td class="p-2 pl-6">transmission_big</td><td class="p-2">0.6 x 0.6 x 0.6</td><td class="p-2">100</td></tr>
                                    <tr><td class="p-2 pl-6">body_big</td><td class="p-2">3.4 x 1.9 x 1.6</td><td class="p-2">280</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="glass-card rounded-xl p-8">
                        <h3 class="text-2xl font-bold mb-4 text-orange-400">`gameState` Structure</h3>
                        <p class="mb-4 text-gray-300">The object you receive from `readline()` will have the following structure:</p>
                        <div class="code-block">
{
  "tick": 123,
  "profit": 1500,
  "peakProfit": 1800,
  "orders": [
    { 
      "id": 102, 
      "models": { "small": 2, "mid": 1 }, // N units of each model
      "maxProfit": 8000, 
      "deadline": 173 
    }
  ],
  "availableParts": [
    { "id": "ch3_2", "type": "chassis_3_wheels" }
  ],
  "docks": [
    {
      "id": 1,
      "status": "loading",
      "truck": { "type": "medium", "eta": 0, "items": [...] }
    }
  ]
}
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Three.js and OrbitControls -->
    <script type="importmap">{"imports": {"three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js","three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"}}</script>
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- UI ELEMENTS ---
        const metricTick = document.getElementById('metric-tick');
        const metricLucro = document.getElementById('metric-lucro');
        const metricPicoLucro = document.getElementById('metric-pico-lucro');
        const docksContainer = document.getElementById('docks-container');
        const logContent = document.getElementById('log-content');
        const botCodeEditor = document.getElementById('bot-code-editor');
        const runBotButton = document.getElementById('run-bot-button');
        const codeStatus = document.getElementById('code-status');
        const metricStatus = document.getElementById('metric-status');
        const botNameInput = document.getElementById('bot-name-input');

        // --- GAME CONFIG ---
        const TICK_RATE = 1500;
        const ORDER_DEADLINE_TICKS = 50;
        const TRUCK_DIMS = { 
            small: { w: 2, h: 2, d: 5, maxWeight: 1500, cost: 120 }, 
            medium: { w: 2.5, h: 2.5, d: 8, maxWeight: 4000, cost: 250 }, 
            large: { w: 3, h: 2.5, d: 10, maxWeight: 8000, cost: 400 } 
        };
        const PECA_DEFS = {
            'common_wheel': { w: 0.6, h: 0.6, d: 0.2, color: 0x9ca3af, weight: 15 },
            'chassis_3_wheels': { w: 2.2, h: 0.4, d: 1.4, color: 0x3b82f6, weight: 180 },
            'suspension_small_f': { w: 0.3, h: 0.8, d: 0.3, color: 0x10b981, weight: 22 },
            'suspension_small_r': { w: 1.2, h: 0.3, d: 0.3, color: 0x10b981, weight: 28 },
            'engine_small': { w: 0.6, h: 0.5, d: 0.5, color: 0xef4444, weight: 60 },
            'transmission_small': { w: 0.4, h: 0.4, d: 0.4, color: 0x6b7280, weight: 45 },
            'body_small': { w: 2.4, h: 1.5, d: 1.5, color: 0xf59e0b, weight: 120 },
            'chassis_4_wheels': { w: 2.8, h: 0.4, d: 1.6, color: 0x3b82f6, weight: 250 },
            'suspension_mid_f': { w: 0.4, h: 1.0, d: 0.4, color: 0x10b981, weight: 35 },
            'suspension_mid_r': { w: 0.4, h: 1.0, d: 0.4, color: 0x10b981, weight: 35 },
            'engine_mid': { w: 0.7, h: 0.6, d: 0.5, color: 0xef4444, weight: 95 },
            'transmission_mid': { w: 0.5, h: 0.5, d: 0.5, color: 0x6b7280, weight: 70 },
            'body_mid': { w: 3.0, h: 1.5, d: 1.7, color: 0xf59e0b, weight: 180 },
            'offroad_wheel': { w: 0.8, h: 0.8, d: 0.3, color: 0x9ca3af, weight: 35 },
            'reinforced_chassis': { w: 3.2, h: 0.5, d: 1.8, color: 0x3b82f6, weight: 400 },
            'suspension_big_f': { w: 0.5, h: 1.2, d: 0.5, color: 0x10b981, weight: 55 },
            'suspension_big_r': { w: 0.5, h: 1.2, d: 0.5, color: 0x10b981, weight: 55 },
            'engine_big': { w: 0.8, h: 0.6, d: 0.6, color: 0xef4444, weight: 140 },
            'transmission_big': { w: 0.6, h: 0.6, d: 0.6, color: 0x6b7280, weight: 100 },
            'body_big': { w: 3.4, h: 1.6, d: 1.9, color: 0xf59e0b, weight: 280 },
        };
        const MODELOS = {
            small: ['chassis_3_wheels', 'common_wheel', 'common_wheel', 'common_wheel', 'suspension_small_f', 'suspension_small_r', 'engine_small', 'transmission_small', 'body_small'],
            mid: ['chassis_4_wheels', 'common_wheel', 'common_wheel', 'common_wheel', 'common_wheel', 'suspension_mid_f', 'suspension_mid_r', 'engine_mid', 'transmission_mid', 'body_mid'],
            big: ['reinforced_chassis', 'offroad_wheel', 'offroad_wheel', 'offroad_wheel', 'offroad_wheel', 'suspension_big_f', 'suspension_big_r', 'engine_big', 'transmission_big', 'body_big']
        };

        // --- GAME STATE ---
        let gameInterval = null;
        let currentUserBotLogic = null;
        let nextOrderId = 101;
        let nextPecaId = 1;

        const createNewOrder = (currentTick) => {
            const modelos = {};
            if (Math.random() > 0.3) modelos.small = Math.ceil(Math.random() * 2);
            if (Math.random() > 0.6) modelos.mid = 1;
            if (Object.keys(modelos).length === 0) modelos.small = 1;

            const order = {
                id: nextOrderId++,
                models: modelos,
                maxProfit: Object.entries(modelos).reduce((sum, [key, val]) => sum + (val * (key === 'small' ? 2000 : 4000)), 0),
                deadline: currentTick + ORDER_DEADLINE_TICKS + 20
            };
            return order;
        };
        
        const getPecasForOrder = (order) => {
            let pecas = [];
            for (const [modelo, quantidade] of Object.entries(order.models)) {
                for (let i = 0; i < quantidade; i++) {
                    pecas.push(...MODELOS[modelo]);
                }
            }
            return pecas;
        };

        const getInitialGameState = () => {
             const initialOrders = [createNewOrder(0), createNewOrder(5)];
             const pecasNecessarias = initialOrders.flatMap(getPecasForOrder);
             const pecasDisponiveis = pecasNecessarias.map(tipo => ({ id: `${tipo.substring(0,2)}_${nextPecaId++}`, type: tipo }));

            return {
                tick: 0,
                profit: 0,
                peakProfit: 0,
                tickCost: 1,
                inactiveTicks: 0,
                lossTicks: 0,
                orders: initialOrders,
                availableParts: pecasDisponiveis,
                docks: [
                    { id: 1, status: 'empty', truck: null, threeScene: null, ui: {} },
                    { id: 2, status: 'empty', truck: null, threeScene: null, ui: {} },
                    { id: 3, status: 'empty', truck: null, threeScene: null, ui: {} },
                    { id: 4, status: 'empty', truck: null, threeScene: null, ui: {} },
                ],
                log: [],
            }
        };

        let gameState = getInitialGameState();

        // --- DUMMY BOT EXAMPLE ---
        const dummyBotExample = `
// On each tick, your code is executed.
// Use readline() to get the game state and print() to send commands.

const gameState = JSON.parse(readline());
debug(\`Tick: \${gameState.tick}, Profit: \${gameState.profit}\`);

function countItems(arr) {
    return arr.reduce((acc, val) => {
        acc[val] = (acc[val] || 0) + 1;
        return acc;
    }, {});
}

// Main Logic
const loadingDock = gameState.docks.find(d => d.status === 'loading');

if (loadingDock) {
    // If loading, continue or dispatch
    const firstOrder = gameState.orders[0];
    if (!firstOrder) return;

    const requiredPartsForOrder = [];
    for (const [model, qty] of Object.entries(firstOrder.models)) {
        for (let i = 0; i < qty; i++) {
            requiredPartsForOrder.push(...MODELOS[model]);
        }
    }
    
    const partsInTruck = loadingDock.truck.items.map(p => p.type);
    const requiredCounts = countItems(requiredPartsForOrder);
    const inTruckCounts = countItems(partsInTruck);

    let missingPart = null;
    for (const partType in requiredCounts) {
        if ((inTruckCounts[partType] || 0) < requiredCounts[partType]) {
            missingPart = partType;
            break;
        }
    }

    if (missingPart) {
        const availablePart = gameState.availableParts.find(p => p.type === missingPart);
        if (availablePart) {
            const y = loadingDock.truck.items.reduce((acc, item) => acc + item.h, 0); // Simple stacking
            // 5% chance to place out of bounds to test dismissal
            let x = (Math.random() < 0.05) ? 999 : 0;
            print(\`load \${availablePart.id} \${x} \${y.toFixed(1)} 0 XYZ dock_\${loadingDock.id}\`);
        } else {
            debug(\`Part \${missingPart} needed, but not available.\`);
        }
    } else {
        debug(\`Order #\${firstOrder.id} complete. Dispatching...\`);
        print(\`dispatch dock_\${loadingDock.id}\`);
    }

} else {
    // If no dock is loading, call a truck
    const emptyDock = gameState.docks.find(d => d.status === 'empty');
    if (emptyDock) {
        debug('Found empty dock, requesting truck...');
        print(\`request_truck medium dock_\${emptyDock.id}\`);
    }
}
        `;

        // --- GAME ENGINE ---
        function runTick() {
            gameState.tick++;
            gameState.profit -= gameState.tickCost;
            gameState.tickCost += 0.5;

            // Update timers and statuses
            gameState.docks.forEach(dock => {
                if (dock.truck && dock.truck.eta > 0) {
                    dock.truck.eta--;
                    if (dock.truck.eta === 0) {
                        if (dock.status === 'waiting') {
                            dock.status = 'loading';
                            addLog('SERVER', `Truck ${dock.truck.type} arrived at dock ${dock.id}.`, 'green');
                        } else if (dock.status === 'in_transit') {
                            dock.status = 'empty';
                            addLog('SERVER', `Truck from dock ${dock.id} has returned.`, 'green');
                            dock.truck = null;
                        }
                    }
                }
            });
            
            // Generate new orders
            if (Math.random() < 0.1 && gameState.orders.length < 5) {
                const newOrder = createNewOrder(gameState.tick);
                gameState.orders.push(newOrder);
                addLog('SYSTEM', `New order #${newOrder.id} received. Deadline: tick ${newOrder.deadline}.`, 'yellow');
            }

            const commands = [];
            const debugMessages = [];
            try {
                if (currentUserBotLogic) {
                    const readline = () => JSON.stringify(gameState);
                    const print = (command) => commands.push(command);
                    const debug = (message) => debugMessages.push(message);
                    
                    currentUserBotLogic(readline, print, debug, MODELOS);
                    
                    debugMessages.forEach(msg => addLog('BOT_DEBUG', msg, 'debug'));
                    processCommands(commands);
                }
            } catch (e) {
                addLog('BOT_ERROR', e.message, 'red');
                stopGame('BOT ERROR');
                return;
            }

            // Check dismissal criteria
            if (gameState.orders.some(p => gameState.tick > p.deadline)) {
                const expiredOrder = gameState.orders.find(p => gameState.tick > p.deadline);
                stopGame(`Order #${expiredOrder.id} Expired`);
                return;
            }
            if(commands.length === 0) gameState.inactiveTicks++; else gameState.inactiveTicks = 0;
            if(gameState.inactiveTicks >= 6) { stopGame('Inactivity'); return; }
            if(gameState.profit < 0) gameState.lossTicks++; else gameState.lossTicks = 0;
            if(gameState.lossTicks >= 100) { stopGame('Continuous Loss'); return; }

            updateUI();
        }

        function getRotatedDimensions(pecaDef, orientation) {
            const { w, h, d } = pecaDef;
            // Simplified for prototype
            switch (orientation) {
                case 'XYZ': return { width: w, height: h, depth: d };
                case 'XZY': return { width: w, height: d, depth: h };
                case 'YXZ': return { width: h, height: w, depth: d };
                case 'YZX': return { width: d, height: w, depth: h };
                case 'ZXY': return { width: h, height: d, depth: w };
                case 'ZYX': return { width: d, height: h, depth: w };
                default: return { width: w, height: h, depth: d };
            }
        }

        function processCommands(commands) {
            commands.forEach(commandStr => {
                if (!gameInterval) return;
                const parts = commandStr.split(' ');
                const action = parts[0];
                addLog('BOT', `> ${commandStr}`);

                switch(action) {
                    case 'request_truck':
                        const [, tipo, docaIdStr] = parts;
                        const docaId = parseInt(docaIdStr.replace('dock_', ''));
                        const doca = gameState.docks.find(d => d.id === docaId);
                        if (doca && doca.status === 'empty') {
                            const truckCost = TRUCK_DIMS[tipo].cost;
                            gameState.profit -= truckCost;
                            doca.status = 'waiting';
                            doca.truck = { type: tipo, eta: 5, items: [] };
                            addLog('SERVER', `< OK: Truck ${tipo} en route. Cost: -$${truckCost}.`, 'green');
                        } else {
                            addLog('SERVER', `< ERROR: Dock ${docaId} is not empty.`, 'red');
                        }
                        break;
                    case 'load':
                        const [, pecaId, xStr, yStr, zStr, orient, docaLoadIdStr] = parts;
                        const [x, y, z] = [parseFloat(xStr), parseFloat(yStr), parseFloat(zStr)];
                        const docaLoadId = parseInt(docaLoadIdStr.replace('dock_', ''));
                        const docaLoad = gameState.docks.find(d => d.id === docaLoadId);
                        const pecaIndex = gameState.availableParts.findIndex(p => p.id === pecaId);
                        
                        if(docaLoad && docaLoad.status === 'loading' && pecaIndex !== -1) {
                            const pecaDef = PECA_DEFS[gameState.availableParts[pecaIndex].type];
                            const truckDef = TRUCK_DIMS[docaLoad.truck.type];
                            const rotatedDims = getRotatedDimensions(pecaDef, orient);

                            if (x < 0 || y < 0 || z < 0 ||
                                x + rotatedDims.depth > truckDef.d ||
                                y + rotatedDims.height > truckDef.h ||
                                z + rotatedDims.width > truckDef.w) {
                                addLog('SERVER', `< DISMISSED: Attempted to place part out of bounds.`, 'red');
                                stopGame('Out of Bounds');
                                return;
                            }

                            const currentWeight = docaLoad.truck.items.reduce((sum, item) => sum + item.weight, 0);
                            if (currentWeight + pecaDef.weight > truckDef.maxWeight) {
                                addLog('SERVER', `< DISMISSED: Truck overweight.`, 'red');
                                stopGame('Overweight');
                                return;
                            }
                            // TODO: Add collision and support validation here.

                            const [peca] = gameState.availableParts.splice(pecaIndex, 1);
                            docaLoad.truck.items.push({ ...pecaDef, type: peca.type, x, y, z });
                            addLog('SERVER', `< OK: Part ${peca.id} loaded.`, 'green');
                        } else {
                            addLog('SERVER', `< ERROR: Cannot load ${pecaId}.`, 'red');
                        }
                        break;
                    case 'dispatch':
                        const [, docaDispatchIdStr] = parts;
                        const docaDispatchId = parseInt(docaDispatchIdStr.replace('dock_', ''));
                        const docaDispatch = gameState.docks.find(d => d.id === docaDispatchId);
                        if (docaDispatch && docaDispatch.status === 'loading') {
                            if (docaDispatch.truck.items.length === 0) {
                                addLog('SERVER', `< DISMISSED: Attempted to dispatch an empty truck.`, 'red');
                                stopGame('Empty Truck');
                                return;
                            }

                            const pecasCarregadas = docaDispatch.truck.items.map(p => p.type).sort();
                            const pedidoIndex = gameState.orders.findIndex(p => {
                                const pecasDoPedido = getPecasForOrder(p).sort();
                                return JSON.stringify(pecasDoPedido) === JSON.stringify(pecasCarregadas);
                            });

                            if (pedidoIndex !== -1) {
                                const [pedido] = gameState.orders.splice(pedidoIndex, 1);
                                gameState.profit += pedido.maxProfit;
                                gameState.peakProfit = Math.max(gameState.peakProfit, gameState.profit);
                                docaDispatch.status = 'in_transit';
                                docaDispatch.truck.eta = 20;
                                addLog('SERVER', `< OK: Dock ${docaDispatch.id} dispatched with order #${pedido.id}. Profit: +$${pedido.maxProfit}.`, 'green');
                            } else {
                                addLog('SERVER', `< DISMISSED: Attempted to dispatch an incomplete order.`, 'red');
                                stopGame('Incomplete Order');
                            }
                        } else {
                            addLog('SERVER', `< ERROR: Cannot dispatch from dock ${docaDispatchId}.`, 'red');
                        }
                        break;
                }
            });
        }

        function stopGame(reason) {
            if (gameInterval) clearInterval(gameInterval);
            gameInterval = null;
            metricStatus.innerHTML = `<span class="relative flex h-3 w-3"><span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span></span><p class="text-xl font-bold text-red-400">DISMISSED</p>`;
            addLog('SYSTEM', `Simulation stopped: ${reason}`, 'red');
            updateUI();
            setTimeout(() => {
                alert(`GAME OVER!\nReason: ${reason}\n\nYour final score (peak profit) was: $ ${gameState.peakProfit.toLocaleString('en-US')}`);
            }, 100);
        }

        // --- UI FUNCTIONS ---
        function initializeUI() {
            docksContainer.innerHTML = '';
            gameState.docks.forEach(dock => {
                const dockEl = document.createElement('div');
                dockEl.className = 'glass-card rounded-xl p-4 flex flex-col';
                dockEl.innerHTML = `
                    <h3 class="font-bold text-lg mb-2"></h3>
                    <div class="dock-content-wrapper bg-gray-900 rounded-md p-2 flex-grow h-52">
                        <div class="dock-state-empty w-full h-full border-2 border-dashed border-gray-700 rounded flex items-center justify-center"><p class="text-gray-600">Awaiting truck</p></div>
                        <div class="dock-state-timer hidden flex-col items-center justify-center h-full"></div>
                        <div class="dock-state-canvas hidden w-full h-full"><canvas></canvas></div>
                    </div>
                    <p class="dock-footer text-xs text-gray-500 mt-2 text-center invisible">_</p>
                `;
                docksContainer.appendChild(dockEl);
                dock.ui = {
                    header: dockEl.querySelector('h3'),
                    footer: dockEl.querySelector('.dock-footer'),
                    stateEmpty: dockEl.querySelector('.dock-state-empty'),
                    stateTimer: dockEl.querySelector('.dock-state-timer'),
                    stateCanvas: dockEl.querySelector('.dock-state-canvas'),
                    canvas: dockEl.querySelector('canvas'),
                };
            });
            updateUI();
        }

        function updateUI() {
            metricTick.textContent = gameState.tick;
            metricLucro.textContent = `$ ${gameState.profit.toLocaleString('en-US')}`;
            metricPicoLucro.textContent = `$ ${gameState.peakProfit.toLocaleString('en-US')}`;
            
            gameState.docks.forEach(updateDockElement);

            logContent.innerHTML = gameState.log.slice(-15).map(l => `<p><span class="text-gray-500">[${l.tick}]</span> <span class="${l.colorClass}">${l.source}</span> ${l.message}</p>`).join('');
            logContent.scrollTop = logContent.scrollHeight;
        }
        
        function updateDockElement(dock) {
            const { ui } = dock;
            let statusText, statusColor, footerText = '_', footerVisible = 'invisible';

            ui.stateEmpty.classList.add('hidden');
            ui.stateTimer.classList.add('hidden');
            ui.stateCanvas.classList.add('hidden');

            switch(dock.status) {
                case 'empty':
                    statusText = '(Empty)'; statusColor = 'text-gray-400';
                    ui.stateEmpty.classList.remove('hidden');
                    if (dock.threeScene) dock.threeScene = null;
                    break;
                case 'waiting':
                    statusText = '(Waiting)'; statusColor = 'text-yellow-400';
                    ui.stateTimer.classList.remove('hidden');
                    ui.stateTimer.innerHTML = `<p class="text-yellow-400">Truck arrives in:</p><p class="font-mono text-4xl font-bold my-2">${dock.truck.eta} Ticks</p><div class="w-full bg-gray-700 rounded-full h-2.5"><div class="bg-yellow-500 h-2.5 rounded-full" style="width: ${100 - dock.truck.eta * 20}%"></div></div>`;
                    break;
                case 'in_transit':
                    statusText = '(In Transit)'; statusColor = 'text-cyan-400';
                    ui.stateTimer.classList.remove('hidden');
                    ui.stateTimer.innerHTML = `<p class="text-cyan-400">Returning in:</p><p class="font-mono text-4xl font-bold my-2">${dock.truck.eta} Ticks</p><div class="w-full bg-gray-700 rounded-full h-2.5"><div class="bg-cyan-500 h-2.5 rounded-full" style="width: ${100 - dock.truck.eta * 5}%"></div></div>`;
                    if (dock.threeScene) dock.threeScene = null;
                    break;
                case 'loading':
                default:
                    statusText = `(Loading ${dock.truck.type})`; statusColor = 'text-yellow-400';
                    ui.stateCanvas.classList.remove('hidden');
                    if (!dock.threeScene) {
                        dock.threeScene = createDockScene(dock.ui.canvas, dock);
                    }
                    updateDockScene(dock.threeScene, dock);
                    const currentWeight = dock.truck.items.reduce((sum, item) => sum + item.weight, 0);
                    const maxWeight = TRUCK_DIMS[dock.truck.type].maxWeight;
                    footerText = `Weight: ${currentWeight}kg / ${maxWeight}kg`;
                    footerVisible = 'visible';
                    break;
            }
            
            ui.header.innerHTML = `Dock ${dock.id} <span class="text-sm font-normal ${statusColor}">${statusText}</span>`;
            ui.footer.textContent = footerText;
            ui.footer.className = `dock-footer text-xs text-gray-500 mt-2 text-center ${footerVisible}`;
        }

        function addLog(source, message, type = 'default') {
            const colorMap = { default: 'text-cyan-400', green: 'text-green-400', red: 'text-red-400', yellow: 'text-yellow-400', debug: 'text-gray-500' };
            gameState.log.push({ tick: gameState.tick, source: `[${source}]`, message, colorClass: colorMap[type] || colorMap.default });
        }

        // --- THREE.JS FUNCTIONS ---
        function createDockScene(canvas, dock) {
            const scene = new THREE.Scene();
            const truckDims = TRUCK_DIMS[dock.truck.type];
            const camera = new THREE.PerspectiveCamera(50, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
            camera.position.set(truckDims.d * 0.8, truckDims.h * 2, truckDims.w * 2);
            const renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            const controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.target.set(truckDims.d / 3, truckDims.h / 3, 0);
            scene.add(new THREE.AmbientLight(0xffffff, 0.8));
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.7);
            dirLight.position.set(5, 10, 7.5);
            scene.add(dirLight);
            
            const truckLines = new THREE.LineSegments(new THREE.EdgesGeometry(new THREE.BoxGeometry(truckDims.d, truckDims.h, truckDims.w)), new THREE.LineBasicMaterial({ color: 0x6b7280 }));
            truckLines.position.set(truckDims.d / 2, truckDims.h / 2, truckDims.w / 2 - truckDims.w);
            scene.add(truckLines);

            const itemGroup = new THREE.Group();
            scene.add(itemGroup);

            function animate() { requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); }
            animate();
            
            new ResizeObserver(entries => {
                const { width, height } = entries[0].contentRect;
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.setSize(width, height);
            }).observe(canvas.parentElement);

            return { scene, itemGroup, truckDims };
        }

        function updateDockScene(threeScene, dock) {
            if (!threeScene || !dock.truck) return;
            
            while (threeScene.itemGroup.children.length > 0) {
                threeScene.itemGroup.remove(threeScene.itemGroup.children[0]);
            }

            dock.truck.items.forEach(item => {
                const itemMesh = new THREE.Mesh(new THREE.BoxGeometry(item.d, item.h, item.w), new THREE.MeshStandardMaterial({ color: item.color, transparent: true, opacity: 0.9 }));
                itemMesh.position.set(item.x + item.d / 2, item.y + item.h / 2, item.z + item.w / 2 - threeScene.truckDims.w);
                threeScene.itemGroup.add(itemMesh);
            });
        }

        // --- INITIALIZATION ---
        runBotButton.addEventListener('click', () => {
            if (gameInterval) clearInterval(gameInterval);
            
            const userCode = botCodeEditor.value;
            try {
                currentUserBotLogic = new Function('readline', 'print', 'debug', 'MODELOS', userCode);
                codeStatus.textContent = "Code compiled successfully. Starting simulation...";
                codeStatus.className = "text-sm text-green-400";
            } catch (e) {
                codeStatus.textContent = `Syntax error in code: ${e.message}`;
                codeStatus.className = "text-sm text-red-400";
                return;
            }
            
            gameState = getInitialGameState();
            initializeUI();
            addLog('SYSTEM', 'Simulation started with new code.', 'green');
            metricStatus.innerHTML = `<span class="relative flex h-3 w-3"><span class="animate-pulse-fast absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span></span><p id="status-text" class="text-xl font-bold text-green-400">ONLINE</p>`;
            gameInterval = setInterval(runTick, TICK_RATE);
            document.getElementById('execution-section').scrollIntoView({ behavior: 'smooth' });
        });

        botCodeEditor.value = dummyBotExample.trim();
        initializeUI();
        addLog('SYSTEM', 'Prototype loaded. Click "Start" to run the example bot.', 'green');
    </script>

</body>
</html>
